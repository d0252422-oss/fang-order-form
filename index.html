<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fangå¿ƒè³¼ - æ‰“é€ å°ˆå±¬è¨‚å–®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { box-sizing: border-box; }
    html, body { height: 100%; -webkit-overflow-scrolling: touch; }
    * { -webkit-tap-highlight-color: transparent; }
    .elegant-shadow { box-shadow: 0 20px 50px rgba(15, 23, 42, 0.25); }
    .focus-ring:focus-visible { outline: 3px solid rgba(99, 102, 241, 0.5); outline-offset: 2px; }
    .qty-btn {
      transition: all 0.2s ease;
      -webkit-user-select: none;
      user-select: none;
      cursor: pointer;
      touch-action: manipulation;
    }
    .qty-btn:active { transform: scale(0.95); }
    button { -webkit-appearance: none; appearance: none; }
    input[type="text"], input[type="tel"], input[type="number"] {
      -webkit-appearance: none;
      appearance: none;
      border-radius: 12px;
    }
    .store-btn { touch-action: manipulation; -webkit-user-select: none; user-select: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-overlay { animation: fadeIn 0.2s ease-out; }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>

<body class="h-full w-full bg-[#F8FAFC] flex items-center justify-center px-4 md:px-6 py-1.5 md:py-2">
  <div class="w-full max-w-6xl h-full max-h-[920px] mx-auto flex items-center justify-center">
    <div id="order-root" class="w-full h-full bg-white rounded-3xl elegant-shadow border border-[#E2E8F0] overflow-hidden flex flex-col">

      <!-- é ‚éƒ¨å“ç‰Œå€ -->
      <header class="bg-gradient-to-r from-[#FED7AA] to-[#FDBA74] px-6 md:px-8 py-1 md:py-2 flex flex-col md:flex-row md:items-center md:justify-between gap-2 md:gap-3">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-1">
            <div class="w-10 h-10 rounded-xl bg-[#6366F1] flex items-center justify-center">
              <span class="text-white text-xl font-bold">F</span>
            </div>
            <div>
              <h1 id="shop-name" class="text-2xl md:text-3xl font-bold text-[#78350F]">Fangå¿ƒè³¼</h1>
              <p id="shop-tagline" class="text-sm text-[#92400E] mt-0">æ–°é®®å†·å‡ Â· å®‰å¿ƒå–è²¨</p>
            </div>
          </div>
        </div>

        <!-- è¨‚å–®æ‘˜è¦å¡ç‰‡ï¼ˆæ›´æ‰ï¼‰ -->
        <div class="bg-white/90 backdrop-blur-sm rounded-2xl px-5 py-2 border border-[#F97316]/30 min-w-[240px]">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs uppercase tracking-wider text-[#92400E]">è¨‚å–®æ‘˜è¦</span>
            <span class="text-xs text-[#C2410C]">å³æ™‚è¨ˆç®—</span>
          </div>

          <div class="space-y-1.5">
            <div class="flex items-center justify-between">
              <span class="text-sm text-[#78350F]">ç¸½ä»¶æ•¸</span>
              <span id="total-items" class="text-base font-semibold text-[#78350F]">0 ä»¶</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-[#78350F]">ç¸½é‡é‡</span>
              <span id="total-weight" class="text-base font-semibold text-[#78350F]">0 kg</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-[#78350F]">ç¸½é«”ç©</span>
              <span id="total-volume" class="text-base font-semibold text-[#78350F]">0 cmÂ³</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-[#78350F]">é‹è²»</span>
              <span id="shipping-note" class="text-sm font-medium text-[#92400E]">-</span>
            </div>

            <div class="h-px bg-[#F97316]/20 my-1.5"></div>

            <div class="flex items-center justify-between">
              <span class="text-sm text-[#78350F]">é ä¼°é‡‘é¡</span>
              <span class="text-xl font-bold text-[#EA580C]"> $<span id="total-price">0</span> </span>
            </div>

            <div id="volume-warning" class="mt-2 p-2 bg-[#FEE2E2] border border-[#EF4444] rounded-lg hidden">
              <p class="text-xs text-[#991B1B] font-medium leading-relaxed"></p>
            </div>
          </div>
        </div>
      </header>

      <!-- ä¸»è¦å…§å®¹å€ -->
      <main class="flex-1 overflow-y-auto px-6 md:px-8 py-6 space-y-6">
        <!-- å–è²¨é¸é … -->
        <section class="bg-gradient-to-br from-[#F1F5F9] to-[#E2E8F0] rounded-2xl p-5 border border-[#CBD5E1]">
          <div class="flex items-start gap-4">
            <div class="w-8 h-8 rounded-lg bg-[#6366F1] flex items-center justify-center flex-shrink-0 mt-0.5">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </div>
            <div class="flex-1">
              <h2 class="text-base font-semibold text-[#1E293B] mb-1">å–è²¨è¶…å•†é¡å‹</h2>
              <p class="text-sm text-[#64748B] mb-3">è«‹é¸æ“‡æ‚¨æ–¹ä¾¿å–è²¨çš„è¶…å•†æ“šé»</p>
              <div class="grid grid-cols-2 gap-3">
                <button type="button" data-store="711" class="store-btn focus-ring bg-white border-2 border-[#CBD5E1] rounded-xl px-4 py-3 text-sm font-medium text-[#475569] transition-all">7-ELEVEN</button>
                <button type="button" data-store="family" class="store-btn focus-ring bg-white border-2 border-[#CBD5E1] rounded-xl px-4 py-3 text-sm font-medium text-[#475569] transition-all">å…¨å®¶</button>
              </div>
            </div>
          </div>
        </section>

        <!-- è¨‚è³¼äººè³‡è¨Š -->
        <section class="bg-white rounded-2xl border-2 border-[#E2E8F0] p-5">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-8 h-8 rounded-lg bg-[#6366F1] flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </div>
            <div>
              <h2 class="text-base font-semibold text-[#1E293B]">è¨‚è³¼äººè³‡è¨Š</h2>
              <p class="text-sm text-[#64748B]">è«‹å¡«å¯«æ‚¨çš„è¯çµ¡è³‡è¨Š</p>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label for="customer-name" class="block text-sm font-medium text-[#475569] mb-2">è¨‚è³¼äººåç¨± <span class="text-[#EF4444]">*</span></label>
              <input type="text" id="customer-name" class="w-full px-4 py-3 bg-[#F8FAFC] border-2 border-[#CBD5E1] rounded-xl text-[#1E293B] placeholder-[#94A3B8] focus-ring focus:border-[#6366F1] transition-colors" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            </div>
            <div>
              <label for="store-location" class="block text-sm font-medium text-[#475569] mb-2">å–è²¨é–€å¸‚ <span class="text-[#EF4444]">*</span></label>
              <input type="text" id="store-location" class="w-full px-4 py-3 bg-[#F8FAFC] border-2 border-[#CBD5E1] rounded-xl text-[#1E293B] placeholder-[#94A3B8] focus-ring focus:border-[#6366F1] transition-colors" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚ä¸­æ­£å€é¤¨å‰è·¯">
            </div>
            <div>
              <label for="customer-phone" class="block text-sm font-medium text-[#475569] mb-2">å–è²¨äººé›»è©± <span class="text-[#EF4444]">*</span></label>
              <input type="tel" id="customer-phone" class="w-full px-4 py-3 bg-[#F8FAFC] border-2 border-[#CBD5E1] rounded-xl text-[#1E293B] placeholder-[#94A3B8] focus-ring focus:border-[#6366F1] transition-colors" placeholder="ä¾‹å¦‚ï¼š0912-345-678">
            </div>
          </div>
        </section>

        <!-- âœ… å•†å“å€ï¼šå®Œå…¨ç”± Sheet å‹•æ…‹ç”Ÿæˆ -->
        <div id="catalog" class="space-y-6">
          <div id="catalog-loading" class="bg-white rounded-2xl border-2 border-[#E2E8F0] p-5">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-lg bg-[#6366F1] flex items-center justify-center">
                <div class="w-4 h-4 rounded-full border-2 border-white border-t-transparent animate-spin"></div>
              </div>
              <div>
                <div class="text-base font-semibold text-[#1E293B]">æ­£åœ¨è¼‰å…¥å•†å“...</div>
                <div class="text-sm text-[#64748B]">å¾ Google Sheet è®€å–ä¸­</div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- ç¢ºèªé€å–®æŒ‰éˆ•å€ï¼ˆæ›´è²¼åº•ã€æŒ‰éˆ•æ›´æ‰ï¼‰ -->
      <div class="bg-white border-t-2 border-[#E2E8F0] px-6 md:px-8 py-1.5 md:py-2">
        <button type="button" id="submit-order-btn" class="w-full bg-gradient-to-r from-[#6366F1] to-[#4F46E5] text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-200 flex items-center justify-center gap-3 focus-ring disabled:opacity-50 disabled:cursor-not-allowed">
          <svg id="submit-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span id="submit-text" class="text-lg">ç¢ºèªä¸¦é€å‡ºè¨‚å–®</span>
        </button>
        <p id="submit-message" class="text-xs text-center text-[#64748B] mt-3">è¨‚å–®å°‡ç™¼é€è‡³ Google è¡¨å–®</p>
      </div>

      <!-- åº•éƒ¨å‚™è¨»ï¼ˆæ›´çŸ­ï¼‰ -->
      <footer class="bg-[#F8FAFC] border-t border-[#E2E8F0] px-6 md:px-8 py-1 md:py-1.5">
        <p id="footer-note" class="text-xs text-center text-[#64748B] leading-relaxed">æœ¬é é¢ç‚ºè¨‚å–®è©¦ç®—å·¥å…·ï¼Œå¯¦éš›å•†å“èˆ‡åƒ¹æ ¼ä»¥åœ˜è³¼å…¬å‘Šç‚ºæº–ã€‚</p>
      </footer>

    </div>
  </div>

  <!-- è¨‚å–®ç¢ºèªå½ˆçª— -->
  <div id="order-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="modal-overlay bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90%] overflow-y-auto">
      <div class="sticky top-0 bg-gradient-to-r from-[#6366F1] to-[#4F46E5] px-6 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center"><span class="text-3xl">ğŸ›’</span></div>
          <div>
            <h2 class="text-2xl font-bold text-white">è¨‚å–®é€šçŸ¥</h2>
            <p class="text-sm text-white/80">è¨‚å–®å·²æˆåŠŸé€å‡º</p>
          </div>
        </div>
        <button type="button" id="close-modal-btn" class="w-10 h-10 rounded-xl bg-white/20 hover:bg-white/30 flex items-center justify-center transition-colors">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="order-summary-content" class="p-6 space-y-5"></div>
    </div>
  </div>

  <script>
    // =========================
    // åŸºæœ¬è¨­å®š
    // =========================
    const LIFF_ID = "2008554940-VeRlOWJz";
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRx90m9Sgf0zrkv6S44i903b6Z_LUXB283A5eX7g3pzTMJHn3UHFrUUSN9hDzIpyVvjy5v4JGqdg7Xs/pub?output=csv";

    // webhookï¼ˆä¿ç•™ä½ åŸæœ¬ï¼‰
    const WEBHOOK_URL = "https://hook.us2.make.com/n77h23qh56jxi7idshlmcm96yt9qrrc1";

    // productsï¼šç”± Sheet è¦†è“‹ï¼ˆkey=product_idï¼‰
    let products = {};
    // ç”¨ä¾†ä¿ç•™ Sheet çš„åŸå§‹é †åº
    let productOrder = [];

    // åˆ†é¡æ¨£å¼ï¼ˆä½ å¯è‡ªè¡ŒåŠ ï¼‰
    const CATEGORY_STYLE = {
      "å†·å‡æµ·é®®": { emoji:"ğŸ¦", gradient:"from-[#0EA5E9] to-[#06B6D4]", priceClass:"text-[#0EA5E9]", subtitle:"æ·±æµ·ç›´é€ Â· é–ä½é®®å‘³" },
      "å†·å‡è‚‰å“": { emoji:"ğŸ¥©", gradient:"from-[#EF4444] to-[#F97316]", priceClass:"text-[#EF4444]", subtitle:"åš´é¸ç”¢åœ° Â· å“è³ªä¿è­‰" },
      "å†·å‡è”¬èœ": { emoji:"ğŸ¥¦", gradient:"from-[#10B981] to-[#14B8A6]", priceClass:"text-[#10B981]", subtitle:"æ€¥é€Ÿå†·å‡ Â· ä¿ç•™ç‡Ÿé¤Š" }
    };

    function getCategoryStyle(category) {
      const base = CATEGORY_STYLE[category];
      if (base) return base;
      // å…¶ä»–åˆ†é¡ï¼šçµ¦é è¨­é¢¨æ ¼
      return { emoji:"ğŸ“¦", gradient:"from-[#64748B] to-[#334155]", priceClass:"text-[#334155]", subtitle:"è«‹ä»¥å…¬å‘Šè³‡è¨Šç‚ºæº–" };
    }

    // =========================
    // LIFF
    // =========================
    function isInLineApp() {
      const ua = navigator.userAgent.toLowerCase();
      return ua.includes("line");
    }

    async function initLIFF() {
      try {
        if (!isInLineApp()) {
          console.log("é LINE ç’°å¢ƒï¼šå•Ÿç”¨æ¸¬è©¦æ¨¡å¼");
          window.LINE_USER_ID = "test_user";
          window.LINE_NAME = "é è¦½æ¨¡å¼ä½¿ç”¨è€…";
          return;
        }

        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        const profile = await liff.getProfile();
        window.LINE_USER_ID = profile.userId;
        window.LINE_NAME = profile.displayName;

        const nameInput = document.getElementById("customer-name");
        if (nameInput && !nameInput.value.trim()) nameInput.value = profile.displayName;

      } catch (err) {
        console.error("LIFF åˆå§‹åŒ–éŒ¯èª¤:", err);
        window.LINE_USER_ID = "error_user";
        window.LINE_NAME = "æ¸¬è©¦ä½¿ç”¨è€…";
      }
    }

    // =========================
    // CSV è§£æï¼ˆæ”¯æ´å¼•è™Ÿ/é€—è™Ÿï¼‰
    // =========================
    function withCacheBust(url) {
      const sep = url.includes("?") ? "&" : "?";
      return `${url}${sep}cachebust=${Date.now()}`;
    }

    function parseCSV(text) {
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];

        if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (c === "," && !inQuotes) { row.push(cur); cur = ""; continue; }

        if ((c === "\n" || c === "\r") && !inQuotes) {
          if (c === "\r" && next === "\n") i++;
          row.push(cur);
          if (row.some(v => String(v).trim() !== "")) rows.push(row);
          row = []; cur = "";
          continue;
        }

        cur += c;
      }

      row.push(cur);
      if (row.some(v => String(v).trim() !== "")) rows.push(row);
      return rows;
    }

    function toNumber(v, fallback = 0) {
      const n = Number(String(v).trim());
      return Number.isFinite(n) ? n : fallback;
    }

    // =========================
    // å¾ Sheet è¼‰å…¥å•†å“
    // æ¬„ä½ï¼šproduct_id, category, name, price, weight_kg, l_cm, w_cm, h_cm, badge1, badge2
    // =========================
    async function loadProductsFromSheet() {
      const res = await fetch(withCacheBust(SHEET_CSV_URL), { cache: "no-store" });
      if (!res.ok) throw new Error(`Sheet fetch failed: HTTP ${res.status}`);
      const csv = await res.text();

      const table = parseCSV(csv);
      if (table.length < 2) throw new Error("CSV empty");

      const headers = table[0].map(h => String(h).trim());
      const idx = (name) => headers.indexOf(name);

      const col = {
        product_id: idx("product_id"),
        category: idx("category"),
        name: idx("name"),
        price: idx("price"),
        weight_kg: idx("weight_kg"),
        l_cm: idx("l_cm"),
        w_cm: idx("w_cm"),
        h_cm: idx("h_cm"),
        badge1: idx("badge1"),
        badge2: idx("badge2")
      };

      const required = ["product_id","category","name","price","weight_kg","l_cm","w_cm","h_cm"];
      for (const k of required) if (col[k] === -1) throw new Error(`Missing column: ${k}`);

      const nextProducts = {};
      const nextOrder = [];

      for (let r = 1; r < table.length; r++) {
        const row = table[r];

        const pid = String(row[col.product_id] || "").trim();
        if (!pid) continue;

        const category = String(row[col.category] || "").trim();
        const name = String(row[col.name] || "").trim();
        const price = toNumber(row[col.price], NaN);
        if (!Number.isFinite(price)) continue;

        const weight = toNumber(row[col.weight_kg], 0);
        const l = toNumber(row[col.l_cm], 0);
        const w = toNumber(row[col.w_cm], 0);
        const h = toNumber(row[col.h_cm], 0);
        const badge1 = col.badge1 !== -1 ? String(row[col.badge1] || "").trim() : "";
        const badge2 = col.badge2 !== -1 ? String(row[col.badge2] || "").trim() : "";

        nextProducts[pid] = {
          product_id: pid,
          category,
          name,
          price,
          weight,
          volume: { l, w, h },
          badge1,
          badge2
        };
        nextOrder.push(pid);
      }

      products = nextProducts;
      productOrder = nextOrder;

      console.log("âœ… Sheet è¼‰å…¥å®Œæˆï¼š", products);
    }

    // =========================
    // âœ… Sheet Renderï¼šåˆ†é¡è‡ªå‹•ç”Ÿæˆ + å•†å“å¡ç‰‡è‡ªå‹•ç”Ÿæˆ
    // =========================
    function groupByCategoryInOrder() {
      const map = new Map(); // category -> pid[]
      for (const pid of productOrder) {
        const p = products[pid];
        if (!p) continue;
        const cat = p.category || "æœªåˆ†é¡";
        if (!map.has(cat)) map.set(cat, []);
        map.get(cat).push(pid);
      }
      return map;
    }

    function formatWeightBadge(weightKg) {
      if (!weightKg) return "";
      const w = (weightKg === 1) ? "1.0" : weightKg.toFixed(2);
      return `${w} kg`;
    }

    function formatDescByCategory(category, weightKg) {
      const grams = Math.round((weightKg || 0) * 1000);
      const isMeat = String(category || "").includes("è‚‰");
      return isMeat ? `ç´„ ${grams}g / æ”¯` : `${grams}g / åŒ…`;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function renderCatalogFromProducts() {
      const catalog = document.getElementById("catalog");
      if (!catalog) return;

      // æ¸…æ‰ loading
      catalog.innerHTML = "";

      const groups = groupByCategoryInOrder();
      if (groups.size === 0) {
        catalog.innerHTML = `
          <div class="bg-white rounded-2xl border-2 border-[#E2E8F0] p-5">
            <div class="text-base font-semibold text-[#1E293B]">ç›®å‰æ²’æœ‰å•†å“</div>
            <div class="text-sm text-[#64748B] mt-1">è«‹ç¢ºèª Google Sheet æ˜¯å¦æœ‰è³‡æ–™åˆ—</div>
          </div>
        `;
        return;
      }

      for (const [category, pids] of groups.entries()) {
        const style = getCategoryStyle(category);

        const cardsHtml = pids.map(pid => {
          const p = products[pid];
          const tagText = p.badge2 ? `${p.badge1} Â· ${p.badge2}` : (p.badge1 || "");
          const showTag = !!tagText;

          return `
            <div class="flex flex-col md:flex-row md:items-center gap-4 p-4 bg-[#F8FAFC] rounded-xl border border-[#E2E8F0]" data-product-card="${escapeHtml(pid)}">
              <div class="flex-1">
                <div class="flex items-start justify-between mb-2">
                  <h3 class="text-base font-semibold text-[#1E293B]">${escapeHtml(p.name)}</h3>
                  <span class="text-lg font-bold ${style.priceClass}">$${escapeHtml(p.price)}</span>
                </div>
                <p class="text-sm text-[#64748B] mb-2">${escapeHtml(formatDescByCategory(category, p.weight))}</p>
                <div class="flex flex-wrap gap-2">
                  <span class="inline-flex items-center px-2 py-1 rounded-lg bg-[#DBEAFE] text-xs font-medium text-[#1E40AF]">${escapeHtml(formatWeightBadge(p.weight))}</span>
                  <span class="inline-flex items-center px-2 py-1 rounded-lg ${showTag ? "bg-[#FEF3C7] text-[#92400E]" : "hidden"} text-xs font-medium">${escapeHtml(tagText)}</span>
                </div>
              </div>

              <div class="flex items-center gap-3">
                <button type="button" class="qty-btn focus-ring w-10 h-10 rounded-xl bg-[#E2E8F0] flex items-center justify-center text-[#475569] font-bold"
                        data-action="decrease" data-target="${escapeHtml(pid)}"> âˆ’ </button>
                <input type="number" id="${escapeHtml(pid)}" class="w-16 text-center text-lg font-semibold text-[#1E293B] bg-white border-2 border-[#CBD5E1] rounded-xl py-2 focus-ring"
                       value="0" min="0" readonly>
                <button type="button" class="qty-btn focus-ring w-10 h-10 rounded-xl bg-[#6366F1] flex items-center justify-center text-white font-bold"
                        data-action="increase" data-target="${escapeHtml(pid)}"> + </button>
              </div>
            </div>
          `;
        }).join("");

        const sectionHtml = `
          <section class="bg-white rounded-2xl border-2 border-[#E2E8F0] overflow-hidden">
            <div class="bg-gradient-to-r ${style.gradient} px-5 py-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                  <span class="text-2xl">${style.emoji}</span>
                </div>
                <div>
                  <h2 class="text-xl font-bold text-white">${escapeHtml(category)}</h2>
                  <p class="text-sm text-white/80">${escapeHtml(style.subtitle)}</p>
                </div>
              </div>
            </div>
            <div class="p-5 space-y-4">
              ${cardsHtml}
            </div>
          </section>
        `;

        catalog.insertAdjacentHTML("beforeend", sectionHtml);
      }
    }

    // =========================
    // è¨ˆç®—
    // =========================
    function calculateTotal() {
      let totalItems = 0;
      let totalWeight = 0;
      let subtotal = 0;
      let maxLength = 0;
      let maxWidth = 0;
      let maxHeight = 0;

      for (const pid of Object.keys(products)) {
        const input = document.getElementById(pid);
        if (!input) continue;

        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
          const p = products[pid];
          totalItems += qty;
          totalWeight += qty * (p.weight || 0);
          subtotal += qty * (p.price || 0);

          const v = p.volume || { l:0, w:0, h:0 };
          maxLength = Math.max(maxLength, v.l || 0);
          maxWidth  = Math.max(maxWidth,  v.w || 0);
          maxHeight = Math.max(maxHeight, v.h || 0);
        }
      }

      const totalVolume = maxLength * maxWidth * maxHeight;
      const dimensionSum = maxLength + maxWidth + maxHeight;
      const longestEdge = Math.max(maxLength, maxWidth, maxHeight);

      let volumeWarning = '';
      let hasError = false;

      if (totalItems > 0) {
        if (totalWeight > 9) {
          volumeWarning = `âš ï¸ ç¸½é‡é‡ ${totalWeight.toFixed(2)} kg è¶…éé™åˆ¶ï¼ˆå–®ç­†è¨‚å–®ä¸å¯è¶…é 9 kgï¼‰`;
          hasError = true;
        } else if (longestEdge > 45) {
          volumeWarning = `âš ï¸ æœ€é•·é‚Š ${longestEdge} cm è¶…éé™åˆ¶ï¼ˆæœ€é•·é‚Šä¸å¯è¶…é 45 cmï¼‰`;
          hasError = true;
        } else if (dimensionSum > 105) {
          volumeWarning = `âš ï¸ é•·+å¯¬+é«˜ç¸½å’Œ ${dimensionSum} cm è¶…éé™åˆ¶ï¼ˆç¸½å’Œä¸å¯è¶…é 105 cmï¼‰`;
          hasError = true;
        }
      }

      let shippingFee = 0;
      let shippingNote = '-';

      if (subtotal > 0 && subtotal < 1500) { shippingFee = 150; shippingNote = '$150'; }
      else if (subtotal >= 1500 && totalWeight <= 9) { shippingFee = 0; shippingNote = '$0'; }
      else if (subtotal >= 1500 && totalWeight > 9) { shippingFee = 0; shippingNote = 'è¶…é 9kg ç„¡æ³•é€å‡º'; }

      const totalPrice = subtotal + shippingFee;

      document.getElementById('total-items').textContent = totalItems + ' ä»¶';
      document.getElementById('total-weight').textContent = totalWeight.toFixed(2) + ' kg';
      document.getElementById('total-volume').textContent = totalVolume.toLocaleString() + ' cmÂ³';
      document.getElementById('total-price').textContent = totalPrice;

      const shippingEl = document.getElementById('shipping-note');
      shippingEl.textContent = shippingNote;
      if (shippingNote === '$0') shippingEl.className = 'text-sm font-medium text-[#10B981]';
      else if (shippingNote.includes('ç„¡æ³•é€å‡º')) shippingEl.className = 'text-sm font-medium text-[#EF4444]';
      else shippingEl.className = 'text-sm font-medium text-[#EF4444]';

      const warningEl = document.getElementById('volume-warning');
      const submitBtn = document.getElementById('submit-order-btn');
      if (hasError) {
        warningEl.classList.remove('hidden');
        warningEl.querySelector('p').textContent = volumeWarning;
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        warningEl.classList.add('hidden');
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }

    // =========================
    // è¨‚å–®å½ˆçª—
    // =========================
    function showOrderSummary(orderData) {
      const modal = document.getElementById('order-modal');
      const content = document.getElementById('order-summary-content');

      const orderDate = new Date(orderData.order_date);
      const formattedDate = orderDate.toLocaleString('zh-TW', {
        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
      });

      const itemsHtml = orderData.items_list.map(item =>
        `<div class="flex justify-between items-center py-2 border-b border-[#E2E8F0]">
          <span class="text-[#475569]">${escapeHtml(item.name)} x ${item.quantity}</span>
          <span class="font-semibold text-[#1E293B]">$${item.subtotal}</span>
        </div>`
      ).join('');

      content.innerHTML = `
        <div class="bg-[#F8FAFC] rounded-2xl p-5 border border-[#E2E8F0]">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-2xl">ğŸ“‹</span>
            <h3 class="text-lg font-bold text-[#1E293B]">è¨‚å–®ç·¨è™Ÿ</h3>
          </div>
          <p class="text-xl font-mono font-semibold text-[#6366F1]">${escapeHtml(orderData.order_id)}</p>
        </div>

        <div class="bg-[#F8FAFC] rounded-2xl p-5 border border-[#E2E8F0]">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ‘¤</span>
            <h3 class="text-lg font-bold text-[#1E293B]">è¨‚è³¼è³‡è¨Š</h3>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-[#64748B]">å§“åï¼š</span>
              <span class="font-semibold text-[#1E293B]">${escapeHtml(orderData.customer_name)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[#64748B]">é›»è©±ï¼š</span>
              <span class="font-semibold text-[#1E293B]">${escapeHtml(orderData.customer_phone)}</span>
            </div>
          </div>
        </div>

        <div class="bg-[#F8FAFC] rounded-2xl p-5 border border-[#E2E8F0]">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ“¦</span>
            <h3 class="text-lg font-bold text-[#1E293B]">å–è²¨è³‡è¨Š</h3>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-[#64748B]">è¶…å•†ï¼š</span>
              <span class="font-semibold text-[#1E293B]">${escapeHtml(orderData.store_type)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[#64748B]">é–€å¸‚ï¼š</span>
              <span class="font-semibold text-[#1E293B]">${escapeHtml(orderData.store_location)}</span>
            </div>
          </div>
        </div>

        <div class="bg-[#F8FAFC] rounded-2xl p-5 border border-[#E2E8F0]">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ›ï¸</span>
            <h3 class="text-lg font-bold text-[#1E293B]">è¨‚è³¼æ˜ç´°</h3>
          </div>
          <div class="space-y-1">
            ${itemsHtml}
          </div>
        </div>

        <div class="bg-gradient-to-br from-[#FEF3C7] to-[#FED7AA] rounded-2xl p-5 border-2 border-[#F59E0B]">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ’°</span>
            <h3 class="text-lg font-bold text-[#78350F]">é‡‘é¡çµ±è¨ˆ</h3>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-[#92400E]">å•†å“ä»¶æ•¸ï¼š</span>
              <span class="font-semibold text-[#78350F]">${orderData.total_items} ä»¶</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[#92400E]">ç¸½é‡é‡ï¼š</span>
              <span class="font-semibold text-[#78350F]">${orderData.total_weight} kg</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[#92400E]">é‹è²»ï¼š</span>
              <span class="font-semibold text-[#78350F]">${escapeHtml(orderData.shipping_fee)}</span>
            </div>
            <div class="h-px bg-[#F97316]/30 my-3"></div>
            <div class="flex justify-between items-center">
              <span class="text-lg font-bold text-[#78350F]">ç¸½é‡‘é¡ï¼š</span>
              <span class="text-3xl font-bold text-[#EA580C]">$${orderData.total_price}</span>
            </div>
          </div>
        </div>

        <div class="bg-[#F8FAFC] rounded-2xl p-5 border border-[#E2E8F0]">
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <span class="text-xl">ğŸ•</span>
              <span class="text-sm text-[#64748B]">è¨‚å–®æ™‚é–“ï¼š</span>
              <span class="font-semibold text-[#1E293B]">${escapeHtml(formattedDate)}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xl">âœ…</span>
              <span class="text-sm text-[#64748B]">ç‹€æ…‹ï¼š</span>
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-[#DBEAFE] text-sm font-semibold text-[#1E40AF]">${escapeHtml(orderData.status)}</span>
            </div>
          </div>
        </div>
      `;

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // =========================
    // é€å–®
    // =========================
    function formatItemsForText(items) {
      return items.map(item => `${item.name} x${item.quantity} = $${item.subtotal}`).join('\n');
    }

    async function sendToWebhook(orderData) {
      const itemsText = formatItemsForText(orderData.items_list);

      const payload = {
        order_id: orderData.order_id,
        customer_name: orderData.customer_name,
        customer_phone: orderData.customer_phone,
        store_type: orderData.store_type,
        store_location: orderData.store_location,
        items_detail: itemsText,
        total_items: orderData.total_items,
        total_weight: orderData.total_weight,
        shipping_fee: orderData.shipping_fee,
        total_price: orderData.total_price,
        order_date: orderData.order_date,
        status: orderData.status,
        line_user_id: window.LINE_USER_ID || "",
        line_display_name: window.LINE_NAME || ""
      };

      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return true;
    }

    function showMessage(message, type) {
      const submitMessage = document.getElementById('submit-message');
      submitMessage.textContent = message;

      if (type === 'success') submitMessage.className = 'text-sm text-center text-[#10B981] font-medium mt-3';
      else if (type === 'warning') submitMessage.className = 'text-sm text-center text-[#F59E0B] font-medium mt-3';
      else if (type === 'error') submitMessage.className = 'text-sm text-center text-[#EF4444] font-medium mt-3';

      setTimeout(() => {
        submitMessage.textContent = 'è¨‚å–®å°‡ç™¼é€è‡³ Google è¡¨å–®';
        submitMessage.className = 'text-xs text-center text-[#64748B] mt-3';
      }, 3000);
    }

    async function submitOrder() {
      const submitBtn = document.getElementById('submit-order-btn');
      const submitText = document.getElementById('submit-text');
      const submitIcon = document.getElementById('submit-icon');

      if (submitBtn.disabled) return;

      const customerName = document.getElementById('customer-name').value.trim();
      const storeLocation = document.getElementById('store-location').value.trim();
      const customerPhone = document.getElementById('customer-phone').value.trim();
      const selectedStore = document.querySelector('.store-btn[data-selected="true"]');
      const storeKey = selectedStore ? selectedStore.getAttribute('data-store') : '';

      if (!customerName) { showMessage('è«‹å¡«å¯«è¨‚è³¼äººåç¨±', 'error'); return; }
      if (!storeKey) { showMessage('è«‹é¸æ“‡å–è²¨è¶…å•†', 'error'); return; }
      if (!storeLocation) { showMessage('è«‹å¡«å¯«å–è²¨é–€å¸‚', 'error'); return; }
      if (!customerPhone) { showMessage('è«‹å¡«å¯«å–è²¨äººé›»è©±', 'error'); return; }

      const orderItems = [];
      for (const pid of Object.keys(products)) {
        const input = document.getElementById(pid);
        if (!input) continue;

        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
          const p = products[pid];
          orderItems.push({
            product_id: pid,
            name: p.name,
            quantity: qty,
            price: p.price,
            subtotal: qty * p.price
          });
        }
      }

      if (orderItems.length === 0) { showMessage('è«‹è‡³å°‘é¸æ“‡ä¸€é …å•†å“', 'error'); return; }

      const totalItems = parseInt(document.getElementById('total-items').textContent) || 0;
      const totalWeight = parseFloat(document.getElementById('total-weight').textContent) || 0;
      const totalPrice = parseInt(document.getElementById('total-price').textContent) || 0;
      const shippingNote = document.getElementById('shipping-note').textContent;

      submitBtn.disabled = true;
      submitText.textContent = 'é€å‡ºä¸­...';
      submitIcon.innerHTML = '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>';
      submitIcon.classList.add('animate-spin');
      showMessage('æ­£åœ¨å‚³é€è¨‚å–®è³‡è¨Š...', 'loading');

      const orderData = {
        order_id: 'ORD-' + Date.now(),
        customer_name: customerName,
        store_type: storeKey === '711' ? '7-ELEVEN' : 'å…¨å®¶',
        store_location: storeLocation,
        customer_phone: customerPhone,
        items_list: orderItems,
        total_items: totalItems,
        total_weight: totalWeight.toFixed(2),
        shipping_fee: shippingNote,
        total_price: totalPrice,
        order_date: new Date().toISOString(),
        status: 'å·²é€å‡º',
        line_user_id: window.LINE_USER_ID || "",
        line_display_name: window.LINE_NAME || ""
      };

      try {
        await sendToWebhook(orderData);
        showMessage('âœ… è¨‚å–®å·²ç™¼é€è‡³ Google è¡¨å–®ï¼', 'success');
        showOrderSummary(orderData);

        setTimeout(() => {
          document.getElementById('customer-name').value = '';
          document.getElementById('store-location').value = '';
          document.getElementById('customer-phone').value = '';

          for (const pid of Object.keys(products)) {
            const input = document.getElementById(pid);
            if (input) input.value = 0;
          }

          document.querySelectorAll('.store-btn').forEach(btn => {
            btn.removeAttribute('data-selected');
            btn.classList.remove('border-[#6366F1]', 'text-[#6366F1]', 'bg-[#EEF2FF]');
            btn.classList.add('border-[#CBD5E1]', 'text-[#475569]', 'bg-white');
          });

          calculateTotal();
        }, 2000);

      } catch (e) {
        console.error(e);
        showMessage('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      } finally {
        submitIcon.classList.remove('animate-spin');
        submitIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>';
        submitBtn.disabled = false;
        submitText.textContent = 'ç¢ºèªä¸¦é€å‡ºè¨‚å–®';
      }
    }

    // =========================
    // äº‹ä»¶ï¼ˆç”¨äº‹ä»¶å§”æ´¾ï¼Œå‹•æ…‹ç”Ÿæˆä¹Ÿèƒ½ç”¨ï¼‰
    // =========================
    function setupEventDelegation() {
      document.addEventListener("click", (e) => {
        const qtyBtn = e.target.closest(".qty-btn");
        if (qtyBtn) {
          e.preventDefault();
          const action = qtyBtn.getAttribute("data-action");
          const targetId = qtyBtn.getAttribute("data-target");
          const input = document.getElementById(targetId);
          if (!input) return;

          const current = parseInt(input.value) || 0;
          if (action === "increase") input.value = current + 1;
          if (action === "decrease" && current > 0) input.value = current - 1;

          calculateTotal();
          return;
        }

        const storeBtn = e.target.closest(".store-btn");
        if (storeBtn) {
          e.preventDefault();
          document.querySelectorAll('.store-btn').forEach(b => {
            b.removeAttribute('data-selected');
            b.classList.remove('border-[#6366F1]', 'text-[#6366F1]', 'bg-[#EEF2FF]');
            b.classList.add('border-[#CBD5E1]', 'text-[#475569]', 'bg-white');
          });
          storeBtn.setAttribute('data-selected', 'true');
          storeBtn.classList.remove('border-[#CBD5E1]', 'text-[#475569]', 'bg-white');
          storeBtn.classList.add('border-[#6366F1]', 'text-[#6366F1]', 'bg-[#EEF2FF]');
          return;
        }

        const submitBtn = e.target.closest("#submit-order-btn");
        if (submitBtn) {
          e.preventDefault();
          submitOrder();
          return;
        }

        const closeBtn = e.target.closest("#close-modal-btn");
        if (closeBtn) {
          e.preventDefault();
          const modal = document.getElementById("order-modal");
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          return;
        }

        const modal = e.target.closest("#order-modal");
        if (modal && e.target === modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          return;
        }
      });
    }

    // =========================
    // init
    // =========================
    (async function init() {
      setupEventDelegation();
      calculateTotal();
      await initLIFF();

      try {
        await loadProductsFromSheet();
        renderCatalogFromProducts();
        calculateTotal();
      } catch (e) {
        console.warn("âš ï¸ è®€å– Sheet å¤±æ•—ï¼š", e.message);
        const catalog = document.getElementById("catalog");
        if (catalog) {
          catalog.innerHTML = `
            <div class="bg-white rounded-2xl border-2 border-[#E2E8F0] p-5">
              <div class="text-base font-semibold text-[#1E293B]">å•†å“è¼‰å…¥å¤±æ•—</div>
              <div class="text-sm text-[#64748B] mt-1">è«‹ç¢ºèª Sheet æ˜¯å¦å·²ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€ä¸” CSV é€£çµå¯ç›´æ¥é–‹å•Ÿ</div>
              <div class="text-xs text-[#94A3B8] mt-3 break-all">${escapeHtml(SHEET_CSV_URL)}</div>
            </div>
          `;
        }
      }
    })();
  </script>
</body>
</html>
